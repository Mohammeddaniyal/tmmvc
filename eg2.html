<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Stage 2</title>
</head>
<script src="jquery/jquery.js"></script>
<!--MVC library starts here-->
<script>
function tmmvc(){
};
tmmvc.model={};
tmmvc.lastNumValue=0;
tmmvc.runtime={
"onStartup" : [],
"bindings" : []
};
tmmvc.onDocumentLoad=function(func)
{
if((typeof func)!="function") throw "Not a function to load";
tmmvc.runtime.onStartup[tmmvc.runtime.onStartup.length]=func;
}

tmmvc.initFramework=function(){
let x=0;
while(x<tmmvc.runtime.onStartup.length)
{
tmmvc.runtime.onStartup[x++]();
}   
//alert('library');
let elems=document.getElementsByTagName('*');
for(let i=0;i<elems.length;i++)
{
let elem;
let attributeName;
let bindTo;
let previousValue;
elem=elems[i];
if(elem.hasAttribute("tmmvc-attribute"))
{
attributeName=elem.getAttribute("tmmvc-attribute");
if(!attributeName) throw "Invalid tmmvc-attribute";
// Use an Immediately Invoked Function Expression (IIFE) to create a separate scope
// for the current `elem` and `attributeName` values in this loop iteration.
// Without the IIFE, the event listener and setInterval callbacks would capture
// the same outer-scope variables, which get overwritten in subsequent iterations,
// causing all bindings to reference the last element processed.
// Passing `elem` and `attributeName` as parameters ensures each callback works
// with the correct element/model attribute pair.
let tmmvc_bind_to=elem.getAttribute("tmmvc-bind-to");
let tagName;
if(!tmmvc_bind_to)
{
    tagName=elem.tagName.toLowerCase();
    alert("tagName "+tagName);
    // switch to default accordingly the tag
    // for example if the tag is input then value attribute
    // for a(anchoor) its href
    // for img src
    if(tagName=="input" || tagName=="button")
    {
        tmmvc_bind_to="value";
    }else if(tagName=="img")
    {
        tmmvc_bind_to="src";
    }else if(tagName=="select")
    {
        tmmvc_bind_to="option";
    }
    else if(tagName=="a")
    {
        tmmvc_bind_to="href";
    }
    alert("attribute binded "+tmmvc_bind_to)
}
else
{
    // validate is the binded attribute is valid if not throw exception, i guess no need to check is valid
    // or not becuase it allows custom attribvute in js
    // do nothing
    alert("else part "+tmmvc_bind_to)
}

bindTo=tmmvc_bind_to;

(function(elem,attributeName,bindTo)
{
    tagName=elem.tagName.toLowerCase();

previousValue=elem[bindTo]=tmmvc.model[attributeName];
if(tagName=='input')
{
elem.addEventListener('input',function(){
tmmvc.model[attributeName]=$(this).val();
});
}
setInterval(function(){
let x;
for(x=0;x<tmmvc.runtime.bindings.length;++x)
{
    let binding=tmmvc.runtime.bindings[x];
    let currentValue=tmmvc.model[binding.modelProperty];
    if(currentValue!=binding.previousValue)
    {
        binding.previousValue=currentValue;
        binding.element[binding.bindTo]=currentValue;   
    }
}
},200);
let bindingsIndex=tmmvc.runtime.bindings.length;
alert('Bindings length '+bindingsIndex)
tmmvc.runtime.bindings[bindingsIndex]={
    element: elem,
    modelProperty: attributeName,
    bindTo: bindTo,
    previousValue:previousValue
};
})(elem,attributeName,bindTo);
}   
}
}
$(()=>{
tmmvc.initFramework();
});
</script>
<!--User part starts here-->
<script>
var ds={
"num":0,
"button_type":"button",
"name":"daniyal"
};
function doFactorial()
{
var num=ds.num;
var buttonType=ds.button_type;
alert("Button tag type "+document.querySelector("button").type);
var fac=1;
for(var i=num;i>0;i--)
{
fac=fac*i;
}   
alert(fac);
ds.num=fac;
ds.num=0;
ds.button_type="submit";
alert("Button tag type "+document.querySelector("button").type);

//alert(ds.num);
}
tmmvc.onDocumentLoad(initFactorial);
function initFactorial(){
//alert('bobby');
tmmvc.model=ds;
$('#facB').click(doFactorial);
}
</script>
<body>
<input type="number" id="fact" name="'fact" tmmvc-attribute="num"><br>
<button id="facB" tmmvc-attribute="button_type" tmmvc-bind-to="type">Factorial</button><br>
<input type="text" tmmvc-attribute="name"><br>
<
</body>
</html>